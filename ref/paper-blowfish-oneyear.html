<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html><head><title>Dr. Dobb's, Blowfish--One Year Later</title> <style type="text/css" style="display:none">/* styles to hide from Netscape 4.7 */
@import url(http://www.schneier.com/schneier.css);

/* N4-safe duplicates of rules in the "unsafe" stylesheet */
TD { vertical-align: top; }



</style>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"><script src="http://1.2.3.4/bmi-int-js/bmi.js" language="javascript"></script></head><body><table class="main" cellspacing=0><tr><td class="bodycolor"></td><td class="kludge">&nbsp;</td><td class="masthead"><p class="mastname">Bruce Schneier</td><td class="kludge">&nbsp;</td><td class="bodycolor"></td></tr><tr><td class="menua"><P class="menusingle"><a class="menulink" href="/">Blog</a><P class="menusingle"><a class="menulink" href="crypto-gram.html">Crypto-Gram Newsletter</a><P class="menusingle"><a class="menulink" href="books.html">Books</a><P class="menusingle"><a class="menulink" href="essays.html">Essays and Op Eds</a><P class="menusingle"><a class="menulink" href="news.html">News and Interviews</a><P class="menusingle"><a class="menulink" href="av.html">Audio and Video</a><P class="menusingle"><a class="menulink" href="schedule.html">Speaking Schedule</a><P class="menusingle"><a class="menulink" href="passsafe.html">Password Safe</a><P class="menusingle"><a class="menulink" href="cryptography.html">Cryptography</a><P class="menusingle"><a class="menulink" href="about.html">About Bruce Schneier</a><P class="menusingle"><a class="menulink" href="contact.html">Contact Information</a></td><td class="kludge">&nbsp;</td><td class="contentcell"><P><h1>The Blowfish Encryption Algorithm -- One Year Later</h1><p><EM><STRONG>B. Schneier</STRONG></EM></P><p><CITE>Dr. Dobb's Journal</CITE>, September 1995.<P>DES is the workhorse of cryptography algorithms, and it's long past time to replace the 19-year-old standard. The recent design of a $1M machine that could recover a DES key in 3.5 hours only confirmed what everybody knew: DES's key size is far too small for today.<P>The world only partly trusted DES because it survived the scrutiny of the NSA. Experts trusted DES because it was a published standard, and because it survived 20 years of intensive cryptanalysis by cryptographers around the world. Cryptography is like that: confidence in an algorithm grows as group after group tries to break it and fails.<P>Candidates for a replacement are emerging, but none has taken widespread hold. Triple-DES is the conservative approach; IDEA (used in PGP) is the most promising new algorithm. And there is a bevy of unpatented also-rans: RC4 (once a trade secret of RSA Data Security, Inc. but now publicly available on the Internet), SAFER, and my own Blowfish.<P>I first presented Blowfish at the Cambridge Algorithms Workshop (&quot;Description of a New Variable-Length Key, 64-bit Block Cipher (Blowfish),&quot; <CITE>Fast Software Encryption</CITE>, R. Anderson, ed., Lecture Notes in Computer Science #809, Springer-Verlag, 1994) and in <CITE>Dr. Dobb's Journal</CITE> (April 1994). From the start Blowfish was intended to be a completely free--unpatented, unlicensed, and uncopyrighted--alternative to DES. Since then it has been analyzed by some people and has started to see use in some systems, both public and private. This article presents new Blowfish code, as well as updates on the algorithm's security.<H3>Description of Blowfish</H3><P>Blowfish is a block cipher that encrypts data in 8-byte blocks. The algorithm consists of two parts: a key-expansion part and a data-encryption part. Key expansion converts a variable-length key of at most 56 bytes (448 bits) into several subkey arrays totaling 4168 bytes. (Note: the description in this article differs slightly from the one in the April 1994 issue of <CITE>Dr. Dobb's Journal</CITE>; there were typos in steps (5) and (6) of the subkey generation algorithm.)<P>Blowfish has 16 rounds. Each round consists of a key-dependent  permutation, and a key- and data-dependent substitution. All operations are XORs and additions on 32-bit words. The only additional operations are four indexed array data lookups per round.<P>Subkeys:<P>Blowfish uses a large number of subkeys. These keys must be precomputed before any data encryption or decryption. The P-array consists of 18 32-bit subkeys: P1, P2,..., P18. There are also four 32-bit S-boxes with 256 entries each: S1,0, S1,1,..., S1,255; S2,0, S2,1,..,, S2,255; S3,0, S3,1,..., S3,255; S4,0, S4,1,..,, S4,255.<P>Encryption and Decryption:<P>Blowfish has 16 rounds. The input is a 64-bit data element, x. Divide x into two 32-bit halves: xL, xR. Then, for i = 1 to 16:<P>xL = xL XOR Pi<br>xR = F(xL) XOR xR<br>Swap xL and xR<P>After the sixteenth round, swap xL and xR again to undo the last swap. Then, xR = xR XOR P17 and xL = xL XOR P18. Finally, recombine xL and xR to get the ciphertext.<P>Function F looks like this: Divide xL into four eight-bit quarters: a, b, c, and d. Then, F(xL) = ((S1,a + S2,b mod 2<sup>32</sup>) XOR S3,c) + S4,d mod 232.<P>Decryption is exactly the same as encryption, except that P1, P2,..., P18 are used in the reverse order.<P>Generating the Subkeys:<P>The subkeys are calculated using the Blowfish algorithm:<P>1. Initialize first the P-array and then the four S-boxes, in order, with a fixed string. This string consists of the hexadecimal digits of pi (less the initial 3): P1 = 0x243f6a88, P2 = 0x85a308d3, P3 = 0x13198a2e, P4 = 0x03707344, etc.<P>2. XOR P1 with the first 32 bits of the key, XOR P2 with the second 32-bits of the key, and so on for all bits of the key (possibly up to P14). Repeatedly cycle through the key bits until the entire P-array has been XORed with key bits. (For every short key, there is at least one equivalent longer key; for example, if A is a 64-bit key, then AA, AAA, etc., are equivalent keys.)<P>3. Encrypt the all-zero string with the Blowfish algorithm, using the subkeys described in steps (1) and (2).<P>4. Replace P1 and P2 with the output of step (3).<P>5. Encrypt the output of step (3) using the Blowfish algorithm with the modified subkeys.<P>6. Replace P3 and P4 with the output of step (5).<P>7. Continue the process, replacing all entries of the P array, and then all four S-boxes in order, with the output of the continuously changing Blowfish algorithm.<P>In total, 521 iterations are required to generate all required subkeys. Applications can store the subkeys rather than execute this derivation process multiple times.<H4>C Code:</H4><P>C code for Blowfish starts on page xx. This is improved and corrected code; the code in the April 1994 issue had some bugs and was less efficient than this code. The code is also available electronically; see &quot;Availability,&quot; page xx.<H3>Cryptanalysis of Blowfish</H3><P>When I first presented Blowfish last year, Dr. Dobb's Journal sponsored a cryptanalysis contest. There were five submissions in total, and I am pleased to present the most interesting results here.<P>John Kelsey developed an attack that could break 3-round Blowfish, but was unable to extend it. This attack exploits the F function and the fact that addition mod 232 and XOR do not commute. Vikramjit Singh Chhabra looked at ways of efficiently implementing a brute-force keysearch machine.<P>Serge Vaudenay examined a simplified variant of Blowfish, with the S-boxes known and not key-dependent. For this variant, a differential attack can recover the P-array with 28r+1 chosen plaintexts (r is the number of rounds). This attack is impossible for 8-round Blowfish and higher, since more plaintext is required than can possibly be generated with a 64-bit block cipher.<P>For certain weak keys that generate weak S-boxes (the odds of getting them randomly are 1 in 2<sup>14</sup>), the same attack requires only 24r+1 chosen plaintexts to recover the P-array (again, assuming the S-boxes are known). With unknown S-boxes, this attack can detect whether a weak key is being used, but cannot determine what it is (neither the S-boxes, the P-array, nor the key itself). This attack only works against reduced-round variants; it is completely ineffective against 16-round Blowfish.<P>Even so, the discovery of weak keys in Blowfish is significant. A weak key is one for which two entries for a given S-box are identical. There is no way to check for weak keys before doing the key expansion. If you are worried, you have to do the key expansion and check for identical S-box entries after you generate a Blowfish key. I don't think it's necessary, though.<H3>Conclusion</H3><P>No one has come close to developing an attack that breaks Blowfish. Even so, more cryptanalysis is required before pronouncing the algorithm secure. I invite others to continue analyzing the algorithm.<p class="disclaim">Schneier.com is a personal website. Opinions expressed are not necessarily those of <a href="http://www.bt.com/">BT</a>.</td><td class="kludge">&nbsp;</td><td class="rightcol"><table class="sidebox" cellspacing=0><tr><td class="sidemast">Search</td></tr><tr><td class="sidebody"><form method="get" action="http://www.google.com/search"><input type="hidden" name="domains" value="www.schneier.com"> <input type="hidden" name="sitesearch" value="www.schneier.com"> <input id="search" name="q" size="15" maxlength="255"><br><input type="radio" name="hq" value="inurl:www.schneier.com/blog">blog only<br><input type="radio" name="hq" value="inurl:www.schneier.com/essay">essays and op eds only<br><input type="radio" name="hq" value="inurl:www.schneier.com" checked>whole site<br><input type="submit" value="Search"></form></td></tr></table><table class="sidebox" cellspacing=0><tr><td class="sidemast">Crypto-Gram Newsletter</td></tr><tr><td class="sidebody">A free monthly e-mail newsletter on security and security technology.<br><a href="crypto-gram.html">read more</a></td></tr></table><table class="sidebox" cellspacing=0><tr><td class="sidemast">Latest Book</td></tr><tr><td class="sidebody"><a href="book-ce.html"><img class="sidepic" WIDTH="175" HEIGHT="211" alt="Cryptography Engineering book cover" border=0 src="http://1.1.1.5/bmi/www.schneier.com/images/book-ce-175w.jpg"></a><br><a href="books.html">more books by Bruce Schneier</a></td></tr></table><table class="sidebox" cellspacing=0><tr><td class="sidemast">Schneier on Security</td></tr><tr><td class="sidebody">A blog covering security and security technology.<br><a href="blog/">read more</a></td></tr></table></td></tr></table></body></html><script language="javascript"><!--bmi_SafeAddOnload(bmi_load,"bmi_orig_img",1);//-->
</script>